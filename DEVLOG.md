# Sphere Dev Log

Нумерация версий: `MAJOR.MINOR.FEATURE.PATCH`, начинаем с `0.0.0.1`.  
Версия приложения (`version.py`) должна соответствовать последней записи в DEVLOG.  
С версии 0.0.0.5 в конце каждой записи — счётчик строк и символов (Python, без venv). Подсчёт: `python3 scripts/count_lines.py`.

---

## 0.0.0.1 — Инициализация проекта Sphere (Flet)

- Создан базовый каркас приложения на Flet:
  - `main.py`, `app.py`, базовый макет (sidebar, header, чат, заметки, задачи, календарь, база знаний, поиск, настройки).
- Настроены конфиги и хранилища:
  - `config.py` с `AppConfig`, `AIConfig`, директориями `data/`, `assets/`.
  - `database.py` с схемой SQLite (пользователи, заметки, задачи, календарь, знания, чат, поиск, настройки).
  - `vector_db.py` с интеграцией ChromaDB.
- Реализовано ядро ИИ:
  - `AIEngine` с провайдерами Ollama и OpenAI, историей диалогов и обогащением контекстом.
- Базовые модули UI и логики:
  - Заметки (Markdown‑редактор, список, папки).
  - Задачи (канбан‑доска).
  - Календарь.
  - База знаний (импорт документов, чанкинг, индексация).
  - Поиск (по заметкам, задачам и документам).
- Подготовлена структура для future‑фич:
  - Уведомления (локальные и Telegram).
  - Экспорт/импорт данных (JSON, Markdown).
  - Модули обновлений, нейропоиска и DeepSeek‑провайдера.

---

## 0.0.0.2 — UX заметок и файлов

- Заметки:
  - Добавлена булавка в редакторе — можно **закреплять заметки**, они поднимаются вверх списка (`is_pinned` в БД).
  - Переключение папок заметок переведено c `SegmentedButton` на **классические вкладки** (`Tabs + TabBar`).
- Импорт/экспорт:
  - Реализован **экспорт всех заметок в `.md`** в папку `data/exports/notes_YYYYMMDD_HHMMSS/`.
  - Реализован **импорт всех `.md` из выбранной папки** в раздел заметок («Импорт»).
  - Добавлены соответствующие пункты меню в хедере и настройках.
- FilePicker:
  - Исправлена интеграция под Flet 0.80 — используется как сервис, больше нет `Unknown control: FilePicker`.

---

## 0.0.0.3 — Поиск и инфраструктура

- Поиск:
  - Обновлён модуль `SearchModule`: единое поле поиска, фильтры по типам, отображение результатов в виде карточек.
  - Векторный поиск (Chroma) включается только при успешной инициализации, ошибка Chroma не ломает приложение.
- Настройки:
  - Кнопка «Проверить подключение AI» запускает асинхронную проверку всех провайдеров (`ollama`, `openai`).
  - В UI сведены операции над данными: создание бэкапа, экспорт JSON, уведомление об успешных действиях через `SnackBar`.
- DEV‑инфраструктура:
  - Добавлен `DEVLOG.md` с версионированием `0.0.0.x`.
  - Подсчитано количество строк кода, наведен порядок в импортах и стилях под Flet 0.80.

---

## 0.0.0.4 — Локальность, ChromaDB и UX

- **О программе:**
  - Диалог «О программе Sphere» в меню хедера — описание возможностей, акцент на **локальность и конфиденциальность**.
  - Страница «О проекте» в sidebar с автором (Telegram: @losstq) и Dev Log.
- **AI‑провайдеры:**
  - **Удалён OpenAI** — только Ollama (локально) и DeepSeek R1. Фокус на локальных/альтернативных решениях.
- **Загрузка моделей:**
  - Поле ссылки принимает **любой формат** (.zip, .gguf, .bin и т.д.) — в т.ч. архивы с сайта Ollama.
  - Корректное извлечение имени файла из URL (без query‑параметров).
  - Кнопка «Каталог моделей Ollama» открывает ссылку в браузере и копирует её в буфер обмена.
- **ChromaDB:**
  - Обход несовместимости с Python 3.14 (Pydantic v1) — инициализация без `Settings`, подавление UserWarning.
  - При ошибке — мягкое отключение векторного поиска с понятным сообщением.
- **Исправления:**
  - Патч `page.launch_url` на `webbrowser.open()` — устранение RuntimeWarning при клике по ссылкам в Markdown.

---

## 0.0.0.5 — Обновления и версия

- **Версия приложения:**
  - Файл `version.py` с константой `APP_VERSION` (формат 0.0.0.x).
  - В настройках последний пункт — отображение текущей версии.
- **Обновления через Git:**
  - Модуль `utils/updater.py` — проверка новых коммитов в `origin/main` или `origin/master`.
  - Кнопка «Проверить обновления» в настройках — проверка и диалог с предложением применить изменения.
  - Переключатель «Проверять обновления при запуске» — при включении автоматическая проверка при старте.
  - При согласии пользователя — `git pull`, уведомление об успехе и предложение перезапустить приложение.

*Строк: 5 493 | Символов: 191 119*

---

## 0.0.0.6 — ИИ ищет по данным пользователя

- **Удалён отдельный модуль «Поиск»** — вместо него ИИ сам ищет по вашим данным в чате.
- **Чат с контекстом:**
  - При каждом вопросе ИИ автоматически ищет релевантные заметки (текст), задачи и документы базы знаний (семантика).
  - Результаты передаются в контекст — ответ даётся на основе ваших данных.
- **Поле в хедере** — «Спросить ИИ по вашим заметкам, задачам, документам»: ввод и Enter открывают чат и отправляют запрос ИИ.

---

## 0.0.0.7 — Режимы ИИ, чаты и сохранение сессий

- **Режимы общения с ИИ** (переключатель на странице чата):
  - **Только база знаний** — ответы только из заметок, задач и документов пользователя.
  - **Гибрид (знания + модель)** — данные пользователя + знания модели.
  - **Только модель** — только знания модели, без доступа к данным.
- **Именование чатов:**
  - Первый чат за день: `dd.mm.yyyy` (например, 11.02.2026).
  - Следующие чаты за день: `dd.mm.yyyy.0`, `dd.mm.yyyy.1`, `dd.mm.yyyy.2` и т.д.
- **Сохранение сессий:**
  - При смене сессии во время ответа ИИ сообщения сохраняются в правильную сессию.
  - Ответ не теряется и не попадает в другую сессию.
- Режим «Режим поиска» убран из настроек и перенесён на страницу чата.

*Строк: 5 598 | Символов: 196 909*

---

## 0.0.0.8 — Чат, копирование и переключение темы

- **Кнопка «Копировать»** у каждого ответа ИИ — копирует текст в буфер, показывает уведомление «Скопировано».
- **Ответ на выделенный фрагмент:**
  - Выделите текст в сообщении ИИ → Ctrl+C → нажмите кнопку «Ответить».
  - В поле ввода вставляется `По поводу «...»: ` с выделенным текстом.
- **Переключение темы:**
  - Расширены светлая и тёмная темы — добавлены `primary_container`, `secondary_container`, `surface_container`, `outline` и др.
  - Жёстко заданные цвета (`INDIGO_200`, `TEAL_700` и т.п.) заменены на семантические (`PRIMARY`, `SECONDARY`, `PRIMARY_CONTAINER`).
  - Элементы интерфейса корректно отображаются при смене светлой/тёмной темы.

*Строк: 5 690 | Символов: 200 980*

---

## 0.0.0.9 — Полировка UI и тем

- **Темы и фон:**
  - Светлая тема получила лавандовый фон окна (`page.bgcolor = SphereColors.ACCENT`) при сохранении контрастного светлого `surface` для основного контента.
  - Тёмная тема использует единый тёмный фон (`SphereColors.DARK_BG`), переключение темы синхронизирует фон и иконку в хедере.
  - `main_content` теперь всегда рисуется на `surface`, поэтому sidebar/header визуально отделены от рабочей области.
- **Читаемость текста:**
  - Во всех ключевых местах текст переведён на семантический `ON_SURFACE` вместо «почти фоновых» цветов; исправлены проблемные участки в календаре (заголовок, месяц, дни и события).
  - Компонент `ChatMessage` и другие UI‑блоки получили явные цвета для заголовков, подписи и иконок, чтобы не сливаться с фоном ни в светлой, ни в тёмной теме.
- **UX настроек ИИ:**
  - Слайдер «Температура» получил подписи «0 — более точные ответы» и «1 — более креативные», а шаг деления увеличен до `0.05` для тонкой настройки.
  - Поле «Спросить ИИ по вашим заметкам…» в хедере закреплено как основной способ запускать запросы к ИИ.
- **Навигация и поиск:**
  - Быстрая кнопка «Поиск» на дашборде заменена на «Спросить ИИ», чтобы не плодить отдельный сценарий классического поиска поверх чат‑интерфейса.
  - Основные быстрые действия на главной странице ведут в чат, заметки и задачи.

*Строк: 5 784 | Символов: 205 011*

---

## 0.0.0.10 — Иконка, личный кабинет и бекап в Telegram

- **Иконка приложения:**
  - Кастомная иконка-глобус в `assets/icon.png` и `assets/icon_macos.png`.
  - Установка иконки окна в `main.py` и `app.py` (абсолютный путь; при сборке `flet build macos` иконка отображается в доке).
- **README:**
  - Вычеркнуты упоминания OpenAI и облака (оставлен акцент на локальность).
- **Личный кабинет:**
  - Новый пункт в sidebar между «Настройки» и «О проекте» — «Личный кабинет» с иконкой профиля.
  - Вместо облака Google — **бекап через Telegram-бота**: вся информация (заметки, задачи, календарь, документы) в одном JSON; текст весит мало.
- **Выгрузка в Telegram:**
  - Кнопка «Выгрузить всё в Telegram» — создаётся JSON-экспорт и отправляется ботом в чат пользователя.
  - В конфиге сохраняются `last_backup_file_id` и `last_backup_sent_at` (TelegramConfig).
- **Восстановление из Telegram:**
  - Кнопка «Достать бекап из Telegram» — скачивание последней выгруженной копии по `file_id` и восстановление данных (заметки, задачи, события, документы добавляются к текущим).
- **Утилиты:**
  - `utils/telegram_backup.py` — отправка и скачивание файла через Bot API.
  - `utils/file_utils.restore_from_export()` — восстановление из JSON-экспорта в БД.
- **Удалён Google Drive** — конфиг, настройки, модуль и зависимости.

*Строк: 6 081 | Символов: 216 337*

---

## 0.0.0.11 — Хедер, мониторинг ресурсов, компактный сайдбар и тест совместимости

- **Заголовок (строка):**
  - Убраны название «Sphere» и логотип; слева — только **мониторинг ресурсов** (CPU %, RAM в GB), обновление раз в 2 сек.
  - По центру — **только версия** приложения, шрифт крупнее (16px).
  - Зависимость `psutil` для сбора CPU/RAM.
- **Компактный сайдбар:**
  - В настройках (Интерфейс) переключатель **«Компактный сайдбар (только иконки)»** — остаются одни кликабельные иконки, подписи скрываются.
  - Режим сохраняется в `config.ui.sidebar_extended`.
- **Тест совместимости с ИИ:**
  - В настройках блок **«Совместимость с ИИ»**, кнопка **«Проверить устройство»** — выводятся ядра CPU, RAM (всего/свободно), свободное место на диске.
- **Рекомендации моделей:**
  - По результатам теста подбираются **рекомендуемые модели Ollama** под железо (от 1b при <6 GB RAM до 70b/72b при 24+ GB).
- Утилита `utils/resource_monitor.py` — мониторинг и подбор моделей.

*Строк: 6 263 | Символов: 223 358*

---

## 0.0.0.12 — Интенсивность, имя ИИ-агента, кнопки и темы

- **Ползунок интенсивности:**
  - Над слайдером шкала **0 — 0.1 — 0.2 — … — 1**; подпись «Температура» заменена на «Интенсивность».
- **ИИ не фиксирован на Ollama:**
  - В настройках подписи «Хост Ollama», «Модель (Ollama или локальный файл)»; добавлено поле **«Имя ИИ-агента»** (необязательно).
  - При загрузке модели по ссылке имя агента по умолчанию берётся из имени файла; в чате отображается заданное имя вместо «Sphere AI».
  - В конфиг добавлено `ai_agent_name` (сохранение/загрузка).
- **Кнопки по образцу «Загрузить модель»:**
  - Все основные кнопки в настройках и на дашборде переведены на **FilledButton** (более яркие и единообразные).
- **Шрифты и темы:**
  - Заголовки блоков и подписи переключателей (Switch) используют **ON_SURFACE** / **label_text_style**, чтобы при смене темы не было пустых или нечитаемых полей и тумблеров.

*Строк: 6 283 | Символов: 224 828*

---

## 0.0.0.13 — Макет хедера/сайдбара и переключатель сайдбара в хедере

- **Разметка хедера и сайдбара:**
  - Увеличены отступы и ширина блока мониторинга (CPU/RAM), версия вынесена в отдельный контейнер с отступом — элементы хедера больше не наезжают друг на друга.
  - В сайдбаре уменьшены размеры логотипа и текста «Sphere», подправлены отступы leading-блока, чтобы первый пункт меню не перекрывался.
- **Сворачивание сайдбара:**
  - На самой панели сайдбара добавлена кнопка с шевроном (влево/вправо) и подсказкой «Свернуть сайдбар» / «Развернуть сайдбар».
  - Переключатель режима сайдбара **перенесён из настроек в хедер** — кнопка между переключением темы и уведомлениями; иконка и подсказка обновляются при смене режима.
  - Переключатель «Компактный сайдбар» удалён из раздела «Интерфейс» в настройках; режим по-прежнему сохраняется в `config.ui.sidebar_extended`.

*Строк: 6 380 | Символов: 229 125*
